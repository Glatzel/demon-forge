name: manual-build
on:
  workflow_dispatch:
    inputs:
      name:
        description: "Package name"
        type: string
        required: true
      machine:
        description: "machine"
        type: choice
        required: true
        options:
          - windows-latest
          - macos-latest
          - ubuntu-latest
          - ubuntu-24.04-arm
      target-platform:
        description: "target-platform"
        type: choice
        required: true
        options:
          - win-64
          - osx-arm64
          - linux-64
          - linux-aarch64
          - noarch
      upload:
        type: boolean
        description: "upload"
        required: true
        default: false
      publish:
        type: boolean
        description: "publish"
        required: true
        default: false
      debug_on_fail:
        type: boolean
        description: "debug on fail"
        required: true
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref}}-${{inputs.name}}-${{inputs.machine}}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  pull-requests: write
env:
  WORKFLOW_NAME: ${{ github.workflow }}
jobs:
  rattler-build:
    runs-on: ${{inputs.machine}}
    steps:
      - uses: actions/checkout@v6

      - name: Set up pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          run-install: false

      - name: main
        id: main
        env:
          GH_TOKEN: ${{github.token}}
        run: ./packages/${{inputs.name}}/ci-${{inputs.name}}.ps1
        shell: pwsh

      - name: upload
        if: ${{ inputs.upload }}
        uses: actions/upload-artifact@v7
        with:
          name: ${{inputs.name}}-${{inputs.target-platform}}
          path: ./output

      - name: publish
        if: ${{ inputs.publish }}
        run: |
          ./scripts/publish.ps1 -pkg ${{inputs.name}}
        shell: pwsh

      - name: Debug with tmate
        if: ${{failure()&& inputs.debug_on_fail}}
        uses: mxschmitt/action-tmate@v3
