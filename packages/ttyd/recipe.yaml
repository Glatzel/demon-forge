context:
  name: ttyd
  version: "1.7.7"
package:
  version: ${{ version }}
  name: ${{ name }}
source:
  - url: https://github.com/tsl0922/ttyd/archive/refs/tags/${{ version }}.tar.gz
    patches:
      - patch/config.patch
  - if: win
    then:
      - url: https://raw.githubusercontent.com/msys2/MINGW-packages/refs/heads/master/mingw-w64-libwebsockets/001-posix-layout.patch
        target_directory: external/libwebsockets
      - url: https://raw.githubusercontent.com/msys2/MINGW-packages/refs/heads/master/mingw-w64-libwebsockets/002-cmake-remove-build-hash.patch
        target_directory: external/libwebsockets
      - url: https://raw.githubusercontent.com/msys2/MINGW-packages/refs/heads/master/mingw-w64-libwebsockets/PKGBUILD
        target_directory: external/libwebsockets
        patches:
          - patch/libwebsockets.patch
build:
  number: 8
  script: pwsh -Command "& ${{'$env:RECIPE_DIR' if win else '$RECIPE_DIR'}}/build-${{ name }}.ps1"
requirements:
  build:
    - brotlipy
    - cmake 3.*
    - nodejs
    - make
    - fonttools
    - pkg-config
    - if: win
      then:
        - gcc_win-64
        - gxx_win-64
    - if: unix
      then:
        - c-compiler
        - cxx-compiler
        - autoconf
        - automake
        - file
  host:
    - if: unix
      then:
        - json-c
        - libwebsockets
        - zlib
    - if: macos
      then:
        - openssl
  run:
    - if: unix
      then:
        - json-c
        - libwebsockets
        - zlib
    - if: macos
      then:
        - openssl

tests:
  - package_contents:
      bin:
        - ${{ name }}
  - requirements:
      run:
        - curl
    script:
      - pwsh -Command "Start-Process $PREFIX/bin/${{ name }}${{'.exe' if win}} -ArgumentList '--port 7681 pwsh'"
      - curl -sI http://localhost:7681
      - pwsh -Command "Stop-Process -Name ttyd -Force"

about:
  homepage: https://github.com/tsl0922/ttyd
  license: MIT OR Apache-2.0
  summary: A simple command-line tool for sharing terminal over the web
  description: >
    ttyd is a simple command-line tool for sharing terminal over the web. It is
    based on libwebsockets and provides a web-based terminal emulator.
  repository: https://github.com/tsl0922/ttyd
